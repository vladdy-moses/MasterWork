\section{Программное обеспечение модели}

\subsection{Модуль интеграции РИАС ЖКХ с ГИС ЖКХ}

\subsubsection{Общее описание}

Был разработан модуль интеграции <<РИАС ЖКХ. Модуль интеграции с ГИС ЖКХ>>.

Модуль позволяет проводить двусторонний обмен следующими видами информации:
\begin{easylist}
& договоры управления и уставы;
& договоры ресурсоснабжения;
& сведения о домах и помещениях;
& лицевые счета;
& приборы учёта и их показания;
& платёжные документы;
& факты оплат и отзыв платежей;
& перечни работ управляющих организаций;
& проверки ГЖИ и планы проверок.
\end{easylist}

Дополнительно в модуле интеграции с ГИС ЖКХ реализована следующая функциональность:
\begin{easylist}
& получение из ГИС ЖКХ реестра организаций согласно ЕГРЮЛ/ЕГРИП;
& получение из ГИС ЖКХ нормативно-справочной информации (НСИ);
& двусторонний обмен файлами;
& TODO: дополнить.
\end{easylist}

Программное обеспечение использует следующие технологии информационного взаимодействия:
\begin{easylist}
& SOAP по зашифрованному (алгоритм ГОСТ 34.TODO TODO: ссылка) каналу связи с подписью бизнес-данных по xades-bes;
& разбор xml-ответов от веб-сервиса с открытыми данными;
& обмен файлами по зашифрованному (TODO см. выше) каналу связи по принципу REST API;
& парсинг csv-реестров, запакованных в архивах.
\end{easylist}

С программной точки зрения модуль интеграции РИАС ЖКХ с ГИС ЖКХ представляет службу ОС Windows.
Общее количество значимых строк кода превышает 10 тысяч.
При разработки модуля интеграции использовались следующие технологии и библиотеки:
\begin{easylist}
& .NET Framework 4.5;
& язык программирования Visual C\# 6;
& КриптоПРО .NET;
& Json.NET;
& NLog.
\end{easylist}

Модуль разделён на несколько составных частей:
\begin{easylist}
& ядро обмена (AIS.HM.Integration.GIS.Core);
& служба windows (AIS.HM.Integration.GIS.Production);
& тестовый клиент интеграции (AIS.HM.Integration.GIS.Test);
& графический интерфейс для администратора системы и поставщиков информации (AIS.HM.UI.GIS).
\end{easylist}
Каждый компонент программного обеспечения использует модель данных РИАС ЖКХ.
Здесь можно выделить основные сущности РИАС ЖКХ (Организация, Дом, Помещение) и специфичные для модуля (ГИС\_Запрос, ГИС\_Операция, ГИС\_ЛогПлатёжногоШлюза).
Полное описание используемых сущностей логической (концептуальной) модели данных представлено в таблице TODO:таблица.

TODO: таблица (см. выше).

\subsubsection{Механизм информационного обмена}

Основными принципами информационного обмена с ГИС ЖКХ являются:
\begin{easylist}
& поддержание целостности данных, размещённый в РИАС ЖКХ и ГИС ЖКХ;
& максимально быстрая автоматическая выгрузка данных в ГИС ЖКХ;
& интеграция данных из смежных систем, развёрнутых вкупе с РИАС ЖКХ, и дальнейшая передача их в ГИС ЖКХ;
& гарантированность раскрытия информации в ГИС ЖКХ.
\end{easylist}

Согласно реализации информационного взаимодействия с ГИС ЖКХ, описанному в п. TODO:ссылка, было принято весь процесс отправки сообщений в федеральную систему разделить на следующие этапы:
\begin{enumerate}
	\item Для операции обмена (например, выгрузка договоров или приём домов) определяется набор поставщиков информации, которые имеют право формировать такие запросы.
	\item Для каждого поставщика информации формируется запросы: определяется набор данных, подлежащих обмену, формируются первичные XML-представления запросов (untrusted xml request), формируются пакеты в случае пакетной отправки данных.
	\item В отдельном потоке для одиночных запросов или в текущем потоке для пакетных запросов XML-представления подписываются по ГОСТ (TODO: ссылка на ГОСТ) и отправляются в веб-сервисы ГИС ЖКХ по зашифрованному каналу связи. ГУИД ответа (AckResult.MessageGUID) записывается в хранилище данных РИАС ЖКХ.
	\item В отдельном потоке идёт опрос результатов обработки запроса. Если запрос был обработан, запускается необходимый обработчик, который зависит от операции обмена и веб-сервиса.
\end{enumerate}

Также была реализована поэтапная синхронизация поставщиков информации.
Это означает, что если поставщик информации передал в ГИС ЖКХ необходимые полномочия на раскрытие данных региональной информационной системе и разрешил в РИАС ЖКХ обмен, то в следующий сеанс обмена ничего выгружаться из РИАС ЖКХ в ГИС ЖКХ не будет.
Сначала будут из ГИС ЖКХ приниматься данные по договорам (правоустанавливающие документы на раскрытие информации в разрезе домов), затем в РИАС ЖКХ будут импортированы данные о домах (операция hcs-house-management\\ExportHouseData), затем о данных внутри домов (помещения, лицевые счета, приборы учёта и проч.).
Если ошибок при приёме данных не возникло, статус интеграции поставщика информации сменяется на <<Синхронизация с ГИС ЖКХ завершена>> и включаются операции выгрузки данных из РИАС ЖКХ в федеральную информационную систему.

Для уменьшения нагрузки на сервера формирование и отправка запросов происходит раз в сутки и запускается в 3 часа ночи по времени сервера.
Опрос статуса ответа в ГИС ЖКХ проверяется раз в 5 минут.
Обмен информацией о платежах (фактах оплат) при наличии не отправленных платежей происходит раз в 1 -- 5 минут.

\subsubsection{Синхронизация данных}

При получении данных из федеральной системы их необходимо грамотно сопоставить с данными, которые уже имеются в РИАС ЖКХ.
Например, при получении данных о доме, его подъездах и помещениях, существующие помещения по бизнес-ключу (в данном случае это флаг <<Является жилым>> и номер помещения) необходимо обновлять, новые создавать.
Затем необходимо создать связь записи в РИАС ЖКХ с аналогичной записи в ГИС ЖКХ.
Обычно это делается через специальную сущность fgis.GISEntityCompare, в которой каждой необходимой строке в хранилище данных присваивается ГУИД аналогичной записи в ГИС ЖКХ.
Если в ГИС ЖКХ запись является версионной (а согласно целевой схеме ГИС ЖКХ практически все сущности должны быть версионны), то в fgis.GISEntityCompare записывается корневой ГУИД записи, а ГУИД версии с её номером (при наличии) записывается в сущность fgis.GISEntityVersion.
Иногда ГУИД записи в ГИС ЖКХ сохраняется напрямую в сущности РИАС ЖКХ без использования fgis.GISEntityCompare.
Например, так сделано в информации о платежах (или фактах оплат) жителями за ЖКХ.
Это позволяет ускорить выборку данных и гарантировать целостность связи, но не позволяет учитывать удалённые данные из хранилища РИАС ЖКХ.
Таким образом, в любой момент времени можно получить информацию о том, сколько данных каких типов в РИАС ЖКХ синхронизировано с ГИС ЖКХ.

Отдельной трудностью является синхронизация файлов с ГИС ЖКХ.
Во-первых, файловый сервис ГИС ЖКХ или канал связи до него работает медленно как на скачивание, так и на загрузку файлов (обычно файловые сервисы работают медленно только на загрузку файлов).
Во-вторых, технология передачи файлов отличается от передачи сообщений: вместо SOAP используется REST API.
Изначально планировалось, что файлы будут передаваться прямо в SOAP-запросах (TODO: ссылка).
Однако, данный подход является удобным только при выгрузке данных при малом объёме файлов.
В ГИС ЖКХ был реализован абсолютно иной подход, который технически является более совершенным, но накладывает некоторые сложности при его использовании.
Согласно этому подходу файлы можно обмениваться через отдельный файловый сервис, построенный по принципам REST API.
Файл можно скачать и загрузить целиком, если его объём не превышает 5 Мб.
В противном случае файл следует разбивать на части.
Однако, сложность заключается не в самом механизме обмена файлами, а в механизмах сопоставления файлов в ГИС ЖКХ и РИАС ЖКХ.
Дело в том, что файлы в РИАС ЖКХ могут храниться в двух видах: поле FileName (имя файла) в таблице с сущностями и через единое хранилище файлов (no.cmn\$File).
TODO: дописать.

\subsubsection{Пользовательский интерфейс}

Нет сомнения в том, что автоматический обмен РИАС ЖКХ с ГИС ЖКХ должен контролироваться пользователями.
Такая возможность должна быть доступна как администратору системы, так и администраторам организаций-поставщиеов инфомации в ГИС ЖКХ.

Для пользователя РИАС ЖКХ доступны следующие виды контроля за информационным обменом с ГИС ЖКХ:
\begin{easylist}
& информационная панель обмена;
& журнал обмена;
& флаг <<Синхронизирован с ГИС ЖКХ>> в некоторых таблицах и фильтрах;
& описание результата предпроверки данных для выгрузки в ГИС ЖКХ.
\end{easylist}

Информационная панель обмена помогает контролировать ход интеграции с ГИС ЖКХ в разрезе организаций (для администратора системы) и домах, закреплённых за организацией (для всех администраторов).
Примерный вид страниц со списками организаций и домов организации представлен на рисунках~\ref{img:rias-dashboard-list}~и~\ref{img:rias-dashboard-item}.

\myFigure[t]{0.9}{rias-dashboard-list}{Информационная панель обмена с ГИС ЖКХ в разрезе организаций}

\myFigure[t]{0.9}{rias-dashboard-item}{Информационная панель обмена с ГИС ЖКХ в разрезе домов} 

TODO: дополнить.

\subsubsection{Проблемы информационного взаимодействия}

TODO: решить, это надо тут или в описании интеграции с ГИС ЖКХ.
TODO: написать про пречек

\subsection{Платёжный шлюз РИАС ЖКХ}

Решил отдельно выделить платёжный шлюз.
TODO: Дополнить.

\subsection{Модуль интеграции РИАС ЖКХ с <<АИС Город. Система начислений>>}

TODO: Дополнить.

\clearpage
\newpage